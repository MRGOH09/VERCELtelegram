# Admin后台积分管理系统设计方案

## 🎯 核心功能模块

### 1. 用户积分管理
- **用户搜索**: 按用户ID/用户名/分行代码搜索
- **积分历史查看**: 显示用户完整的积分记录
- **手动积分调整**: 增加/减少用户积分
- **连续天数修正**: 手动设置用户连续天数
- **积分重新计算**: 重新计算指定日期范围的积分

### 2. 里程碑管理
- **里程碑配置**: 添加/编辑/删除里程碑奖励
- **奖励规则调整**: 修改奖励分数和触发条件
- **临时奖励**: 创建特殊活动奖励
- **奖励预览**: 模拟奖励触发效果

### 3. 系统监控
- **积分统计**: 每日/每周/每月积分发放统计
- **异常检测**: 识别积分异常用户和记录
- **性能监控**: API响应时间和错误率
- **数据完整性检查**: 检测缺失或重复的积分记录

### 4. 批量操作
- **批量积分修正**: 为多个用户批量调整积分
- **分行积分管理**: 按分行批量操作
- **历史数据修复**: 修复指定时间段的积分问题
- **数据导出**: 导出积分数据报表

## 🔧 技术实现方案

### A. 独立Admin应用 (推荐)
```
/admin-dashboard/
├── pages/
│   ├── index.js          # 仪表板总览
│   ├── users/            # 用户管理
│   ├── scores/           # 积分管理  
│   ├── milestones/       # 里程碑管理
│   ├── logs/             # 操作日志
│   └── tools/            # 修复工具
├── components/
├── lib/
└── api/
```

### B. 集成到PWA-Google
```
/pwa-google/pages/admin/
├── dashboard.js          # 管理员仪表板
├── user-scores.js        # 用户积分管理
├── milestone-config.js   # 里程碑配置
└── repair-tools.js       # 修复工具
```

## 🔐 权限和安全

### 管理员认证
- **多级权限**: 超级管理员 / 分行管理员 / 只读管理员
- **操作审计**: 所有管理操作记录日志
- **IP白名单**: 限制管理后台访问IP
- **操作确认**: 重要操作需要二次确认

### 数据安全
- **备份机制**: 操作前自动备份相关数据
- **回滚功能**: 支持操作撤销
- **操作日志**: 详细记录所有修改操作
- **权限验证**: API级别的权限检查

## 🛠️ 积分修复机制

### 1. 自动修复
```sql
-- 检测缺失的积分记录
SELECT DISTINCT r.user_id, r.ymd 
FROM records r 
LEFT JOIN user_daily_scores s ON r.user_id = s.user_id AND r.ymd = s.ymd 
WHERE s.user_id IS NULL;

-- 重新计算指定用户的积分
CALL recalculate_user_scores('user_id', '2025-09-01', '2025-09-03');
```

### 2. 手动修复工具
- **积分补发**: 为缺失积分的用户补发
- **重复积分清理**: 删除重复的积分记录
- **连续天数修正**: 修正断链的连续记录
- **奖励补发**: 补发遗漏的里程碑奖励

### 3. 批量修复
- **日期范围修复**: 修复指定日期范围内的所有积分
- **用户批量修复**: 批量修复指定用户的积分
- **分行批量修复**: 按分行批量修复积分问题

## 📊 数据修复示例

### 场景1: 用户缺失某天的积分
```javascript
// 修复步骤：
1. 检查用户当天是否有records记录
2. 如果有记录但无积分，重新计算积分
3. 更新连续天数和里程碑奖励
4. 记录修复操作日志
```

### 场景2: 连续天数计算错误
```javascript
// 修复步骤：
1. 获取用户所有积分记录，按日期排序
2. 重新计算每一天的连续天数
3. 重新评估里程碑奖励触发
4. 更新所有受影响的记录
```

### 场景3: 里程碑奖励遗漏
```javascript
// 修复步骤：
1. 检查所有达到里程碑天数但未获得奖励的记录
2. 计算应得但未得的奖励分数
3. 补发奖励并更新积分记录
4. 通知用户补发的奖励
```

## 🔍 监控和预警

### 实时监控
- **积分发放监控**: 监控每日积分发放数量
- **异常用户检测**: 检测积分异常高或低的用户
- **系统健康检查**: 定期检查积分系统完整性

### 预警机制
- **积分异常预警**: 积分计算异常时发送通知
- **数据不一致预警**: 检测到数据不一致时预警
- **系统故障预警**: API错误率过高时预警

## 💡 实施建议

### 阶段1: 基础版本 (1-2周)
- ✅ 用户积分查看和手动调整
- ✅ 基本的积分重新计算功能
- ✅ 简单的操作日志

### 阶段2: 完整版本 (2-3周)
- ✅ 完整的里程碑管理
- ✅ 批量操作功能
- ✅ 系统监控和预警

### 阶段3: 高级版本 (1-2周)
- ✅ 数据可视化报表
- ✅ 自动化修复工具
- ✅ 高级权限管理

## 🚀 即时修复方案

对于当前已存在的问题，我们可以立即实施：

1. **创建修复脚本**: 检测和修复现有积分问题
2. **临时管理工具**: 快速的命令行修复工具
3. **紧急修复API**: 提供紧急修复接口