<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¢é˜…è°ƒè¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            line-height: 1.6;
        }
        .button {
            background: #1677ff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 8px 4px;
            font-size: 14px;
        }
        .log {
            background: #f5f5f5;
            border: 1px solid #d9d9d9;
            padding: 16px;
            border-radius: 6px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 500px;
            overflow-y: auto;
        }
        .success { color: #52c41a; }
        .error { color: #ff4d4f; }
        .info { color: #1677ff; }
    </style>
</head>
<body>
    <h1>ğŸ” æ¨é€è®¢é˜…è°ƒè¯•å™¨</h1>
    
    <button id="getInfo" class="button">è·å–å½“å‰çŠ¶æ€</button>
    <button id="testSubscribe" class="button">æµ‹è¯•è®¢é˜…</button>
    
    <h3>ğŸ“ è°ƒè¯•æ—¥å¿—</h3>
    <div id="log" class="log">ç‚¹å‡»æŒ‰é’®å¼€å§‹è°ƒè¯•...\n</div>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log')
            const timestamp = new Date().toLocaleTimeString()
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info'
            logDiv.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`
            logDiv.scrollTop = logDiv.scrollHeight
        }

        async function getInfo() {
            log('è·å–å½“å‰è®¢é˜…çŠ¶æ€...', 'info')
            try {
                const response = await fetch('/api/debug-subscription', {
                    credentials: 'include'
                })
                const result = await response.json()
                
                if (response.ok) {
                    log(`ç”¨æˆ·: ${result.user?.name} (ID: ${result.user?.id})`, 'success')
                    log(`å½“å‰è®¢é˜…æ•°: ${result.subscriptionCount}`, 'info')
                    
                    if (result.subscriptions && result.subscriptions.length > 0) {
                        result.subscriptions.forEach((sub, i) => {
                            log(`è®¢é˜…${i+1}: ${sub.endpoint.slice(-30)}...`, 'info')
                            log(`  åˆ›å»ºæ—¶é—´: ${sub.created_at}`, 'info')
                            log(`  æœ€åä½¿ç”¨: ${sub.last_used}`, 'info')
                        })
                    }
                } else {
                    log(`è·å–ä¿¡æ¯å¤±è´¥: ${result.error}`, 'error')
                }
            } catch (error) {
                log(`è¯·æ±‚å¤±è´¥: ${error.message}`, 'error')
            }
        }

        async function testSubscribe() {
            log('å¼€å§‹è®¢é˜…æµ‹è¯•...', 'info')
            
            try {
                // è·å–æ¨é€æƒé™
                if (Notification.permission !== 'granted') {
                    const permission = await Notification.requestPermission()
                    if (permission !== 'granted') {
                        log('æ¨é€æƒé™è¢«æ‹’ç»', 'error')
                        return
                    }
                }

                // æ³¨å†ŒService Worker
                const registration = await navigator.serviceWorker.register('/sw.js')
                log('Service Workeræ³¨å†ŒæˆåŠŸ', 'success')

                // è·å–æ¨é€è®¢é˜…
                const subscription = await registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: 'BHn7QgZMASGfPzs_t1h604Z5ku_HlpZufjZZgDO1qiPopryzLII_GaInmuHqiNMhypVkz99dy2ES8tknl8n-ncE'
                })

                log('æµè§ˆå™¨è®¢é˜…æˆåŠŸ', 'success')
                log(`ç«¯ç‚¹: ${subscription.endpoint.slice(-50)}...`, 'info')

                // è°ƒç”¨è°ƒè¯•API
                const response = await fetch('/api/debug-subscription', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        subscription: subscription,
                        deviceInfo: {
                            userAgent: navigator.userAgent
                        }
                    })
                })

                const result = await response.json()
                
                log(`APIå“åº” (${response.status}):`, response.ok ? 'success' : 'error')
                log(`æ­¥éª¤: ${result.step}`, 'info')
                
                if (result.success) {
                    log(`âœ… ${result.message}`, 'success')
                    if (result.data) {
                        log(`æ’å…¥ID: ${result.data.insertedId}`, 'info')
                    }
                } else {
                    log(`âŒ ${result.error}`, 'error')
                    if (result.details) {
                        log(`è¯¦ç»†ä¿¡æ¯: ${JSON.stringify(result.details, null, 2)}`, 'info')
                    }
                }

            } catch (error) {
                log(`æµ‹è¯•å¤±è´¥: ${error.message}`, 'error')
                console.error('è¯¦ç»†é”™è¯¯:', error)
            }
        }

        document.getElementById('getInfo').onclick = getInfo
        document.getElementById('testSubscribe').onclick = testSubscribe
    </script>
</body>
</html>