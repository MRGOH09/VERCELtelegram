<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¨é€é€šçŸ¥æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            line-height: 1.6;
        }
        .button {
            background: #1677ff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 8px 4px;
            font-size: 14px;
        }
        .button:hover {
            background: #0958d9;
        }
        .button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status {
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .success { background: #f6ffed; border: 1px solid #b7eb8f; color: #389e0d; }
        .error { background: #fff2f0; border: 1px solid #ffccc7; color: #cf1322; }
        .info { background: #f0f9ff; border: 1px solid #91d5ff; color: #0958d9; }
        .log {
            background: #f5f5f5;
            border: 1px solid #d9d9d9;
            padding: 16px;
            border-radius: 6px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>ğŸ”” æ¨é€é€šçŸ¥æµ‹è¯•</h1>
    
    <div id="status" class="status info">
        ğŸ“± æ­£åœ¨åˆå§‹åŒ–æ¨é€æœåŠ¡...
    </div>
    
    <div>
        <button id="requestPermission" class="button" disabled>
            ğŸ” è¯·æ±‚æ¨é€æƒé™
        </button>
        <button id="subscribe" class="button" disabled>
            âœ… è®¢é˜…æ¨é€é€šçŸ¥
        </button>
        <button id="unsubscribe" class="button" disabled>
            âŒ å–æ¶ˆè®¢é˜…
        </button>
        <button id="testPush" class="button" disabled>
            ğŸ§ª å‘é€æµ‹è¯•æ¨é€
        </button>
    </div>
    
    <h3>ğŸ“Š æ¨é€çŠ¶æ€</h3>
    <div id="pushStatus" class="info status">
        ç­‰å¾…æ£€æŸ¥æ¨é€æ”¯æŒ...
    </div>
    
    <h3>ğŸ“ æ“ä½œæ—¥å¿—</h3>
    <div id="log" class="log">åˆå§‹åŒ–ä¸­...\n</div>

    <script>
        // æ—¥å¿—å‡½æ•°
        function log(message) {
            const logDiv = document.getElementById('log')
            const timestamp = new Date().toLocaleTimeString()
            logDiv.textContent += `[${timestamp}] ${message}\n`
            logDiv.scrollTop = logDiv.scrollHeight
            console.log(message)
        }

        // çŠ¶æ€æ›´æ–°å‡½æ•°
        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status')
            statusDiv.textContent = message
            statusDiv.className = `status ${type}`
        }

        // æ¨é€çŠ¶æ€æ›´æ–°
        function updatePushStatus(message, type = 'info') {
            const pushStatusDiv = document.getElementById('pushStatus')
            pushStatusDiv.textContent = message
            pushStatusDiv.className = `${type} status`
        }

        // æŒ‰é’®æ§åˆ¶
        function setButtonState(buttonId, enabled) {
            document.getElementById(buttonId).disabled = !enabled
        }

        // åˆå§‹åŒ–æ¨é€é€šçŸ¥
        async function initializePushNotifications() {
            log('å¼€å§‹åˆå§‹åŒ–æ¨é€é€šçŸ¥ç³»ç»Ÿ...')

            // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
            if (!('serviceWorker' in navigator)) {
                updateStatus('âŒ æµè§ˆå™¨ä¸æ”¯æŒService Worker', 'error')
                updatePushStatus('ä¸æ”¯æŒæ¨é€é€šçŸ¥', 'error')
                return false
            }

            if (!('PushManager' in window)) {
                updateStatus('âŒ æµè§ˆå™¨ä¸æ”¯æŒPush API', 'error')
                updatePushStatus('ä¸æ”¯æŒæ¨é€é€šçŸ¥', 'error')
                return false
            }

            log('âœ… æµè§ˆå™¨æ”¯æŒæ¨é€é€šçŸ¥')

            try {
                // æ³¨å†ŒService Worker
                log('æ³¨å†ŒService Worker...')
                const registration = await navigator.serviceWorker.register('/sw.js')
                log('âœ… Service Workeræ³¨å†ŒæˆåŠŸ')

                // æ£€æŸ¥å½“å‰æ¨é€çŠ¶æ€
                const permission = Notification.permission
                log(`å½“å‰æ¨é€æƒé™çŠ¶æ€: ${permission}`)

                updatePushStatus(`æ¨é€æƒé™: ${permission}`, 
                    permission === 'granted' ? 'success' : 
                    permission === 'denied' ? 'error' : 'info')

                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                setButtonState('requestPermission', permission === 'default')
                
                if (permission === 'granted') {
                    const subscription = await registration.pushManager.getSubscription()
                    if (subscription) {
                        log('âœ… æµè§ˆå™¨å­˜åœ¨æ¨é€è®¢é˜…')
                        log(`è®¢é˜…ç«¯ç‚¹: ${subscription.endpoint.slice(-50)}...`)
                        
                        // éªŒè¯æœåŠ¡å™¨æ˜¯å¦ä¹Ÿæœ‰è¿™ä¸ªè®¢é˜…
                        try {
                            const verifyResponse = await fetch('/api/pwa/data', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                credentials: 'include',
                                body: JSON.stringify({ action: 'verify-subscription' })
                            })
                            
                            const verifyResult = await verifyResponse.json()
                            if (verifyResult.hasSubscription) {
                                log('âœ… æœåŠ¡å™¨ä¹Ÿå­˜åœ¨å¯¹åº”è®¢é˜…')
                                setButtonState('unsubscribe', true)
                                setButtonState('testPush', true)
                                updateStatus('âœ… æ¨é€é€šçŸ¥å·²å®Œå…¨å¯ç”¨', 'success')
                            } else {
                                log('âš ï¸  æœåŠ¡å™¨æ²¡æœ‰å¯¹åº”è®¢é˜…ï¼Œéœ€è¦é‡æ–°åŒæ­¥')
                                setButtonState('subscribe', true)
                                updateStatus('âš ï¸  éœ€è¦é‡æ–°åŒæ­¥è®¢é˜…', 'info')
                            }
                        } catch (error) {
                            log('âš ï¸  æ— æ³•éªŒè¯æœåŠ¡å™¨è®¢é˜…çŠ¶æ€ï¼Œå‡è®¾éœ€è¦é‡æ–°è®¢é˜…')
                            setButtonState('subscribe', true)
                            updateStatus('âš ï¸  éœ€è¦é‡æ–°è®¢é˜…æ¨é€æœåŠ¡', 'info')
                        }
                    } else {
                        log('ğŸ“ éœ€è¦è®¢é˜…æ¨é€æœåŠ¡')
                        setButtonState('subscribe', true)
                        updateStatus('ğŸ“ éœ€è¦è®¢é˜…æ¨é€æœåŠ¡', 'info')
                    }
                } else if (permission === 'denied') {
                    updateStatus('âŒ æ¨é€æƒé™è¢«æ‹’ç»ï¼Œè¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸', 'error')
                } else {
                    updateStatus('ğŸ” éœ€è¦è¯·æ±‚æ¨é€æƒé™', 'info')
                }

                return true

            } catch (error) {
                log(`âŒ åˆå§‹åŒ–å¤±è´¥: ${error.message}`)
                updateStatus('âŒ åˆå§‹åŒ–æ¨é€æœåŠ¡å¤±è´¥', 'error')
                return false
            }
        }

        // è¯·æ±‚æ¨é€æƒé™
        async function requestPermission() {
            log('è¯·æ±‚æ¨é€æƒé™...')
            try {
                const permission = await Notification.requestPermission()
                log(`æƒé™è¯·æ±‚ç»“æœ: ${permission}`)
                
                if (permission === 'granted') {
                    updateStatus('âœ… æ¨é€æƒé™å·²è·å¾—', 'success')
                    setButtonState('requestPermission', false)
                    setButtonState('subscribe', true)
                    updatePushStatus('æ¨é€æƒé™: granted', 'success')
                } else {
                    updateStatus('âŒ æ¨é€æƒé™è¢«æ‹’ç»', 'error')
                    updatePushStatus('æ¨é€æƒé™: denied', 'error')
                }
            } catch (error) {
                log(`âŒ æƒé™è¯·æ±‚å¤±è´¥: ${error.message}`)
                updateStatus('âŒ æƒé™è¯·æ±‚å¤±è´¥', 'error')
            }
        }

        // è®¢é˜…æ¨é€é€šçŸ¥
        async function subscribePush() {
            log('å¼€å§‹è®¢é˜…æ¨é€é€šçŸ¥...')
            try {
                const registration = await navigator.serviceWorker.ready
                
                const subscription = await registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: 'BHn7QgZMASGfPzs_t1h604Z5ku_HlpZufjZZgDO1qiPopryzLII_GaInmuHqiNMhypVkz99dy2ES8tknl8n-ncE'
                })

                log('âœ… æµè§ˆå™¨è®¢é˜…æˆåŠŸ')
                log(`è®¢é˜…ç«¯ç‚¹: ${subscription.endpoint}`)

                // å‘é€è®¢é˜…ä¿¡æ¯åˆ°æœåŠ¡å™¨
                const response = await fetch('/api/pwa/data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        action: 'subscribe-push',
                        subscription: subscription,
                        service: 'fcm',
                        deviceInfo: {
                            userAgent: navigator.userAgent,
                            browser: navigator.userAgentData?.brand || 'unknown'
                        }
                    })
                })

                const result = await response.json()
                
                if (result.success) {
                    log('âœ… æœåŠ¡å™¨è®¢é˜…ä¿å­˜æˆåŠŸ')
                    updateStatus('âœ… æ¨é€è®¢é˜…æˆåŠŸï¼', 'success')
                    setButtonState('subscribe', false)
                    setButtonState('unsubscribe', true)
                    setButtonState('testPush', true)
                    updatePushStatus('å·²è®¢é˜…æ¨é€é€šçŸ¥', 'success')
                } else {
                    throw new Error(result.error || 'æœåŠ¡å™¨ä¿å­˜è®¢é˜…å¤±è´¥')
                }

            } catch (error) {
                log(`âŒ è®¢é˜…å¤±è´¥: ${error.message}`)
                updateStatus('âŒ æ¨é€è®¢é˜…å¤±è´¥', 'error')
            }
        }

        // å–æ¶ˆè®¢é˜…
        async function unsubscribePush() {
            log('å¼€å§‹å–æ¶ˆæ¨é€è®¢é˜…...')
            try {
                const registration = await navigator.serviceWorker.ready
                const subscription = await registration.pushManager.getSubscription()

                if (subscription) {
                    await subscription.unsubscribe()
                    log('âœ… æµè§ˆå™¨å–æ¶ˆè®¢é˜…æˆåŠŸ')
                }

                // é€šçŸ¥æœåŠ¡å™¨å–æ¶ˆè®¢é˜…
                const response = await fetch('/api/pwa/data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        action: 'unsubscribe-push'
                    })
                })

                const result = await response.json()
                
                if (result.success) {
                    log('âœ… æœåŠ¡å™¨å–æ¶ˆè®¢é˜…æˆåŠŸ')
                    updateStatus('âœ… å·²å–æ¶ˆæ¨é€è®¢é˜…', 'success')
                    setButtonState('subscribe', true)
                    setButtonState('unsubscribe', false)
                    setButtonState('testPush', false)
                    updatePushStatus('æœªè®¢é˜…æ¨é€é€šçŸ¥', 'info')
                } else {
                    throw new Error(result.error || 'æœåŠ¡å™¨å–æ¶ˆè®¢é˜…å¤±è´¥')
                }

            } catch (error) {
                log(`âŒ å–æ¶ˆè®¢é˜…å¤±è´¥: ${error.message}`)
                updateStatus('âŒ å–æ¶ˆè®¢é˜…å¤±è´¥', 'error')
            }
        }

        // å‘é€æµ‹è¯•æ¨é€
        async function sendTestPush() {
            log('å‘é€æµ‹è¯•æ¨é€é€šçŸ¥...')
            try {
                const response = await fetch('/api/pwa/data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        action: 'test-push-notification'
                    })
                })

                const result = await response.json()
                
                if (result.success) {
                    log('âœ… æµ‹è¯•æ¨é€å‘é€æˆåŠŸ')
                    updateStatus('âœ… æµ‹è¯•æ¨é€å·²å‘é€ï¼è¯·æŸ¥çœ‹é€šçŸ¥', 'success')
                } else {
                    throw new Error(result.message || 'æµ‹è¯•æ¨é€å‘é€å¤±è´¥')
                }

            } catch (error) {
                log(`âŒ å‘é€æµ‹è¯•æ¨é€å¤±è´¥: ${error.message}`)
                updateStatus('âŒ å‘é€æµ‹è¯•æ¨é€å¤±è´¥', 'error')
            }
        }

        // äº‹ä»¶ç›‘å¬
        document.getElementById('requestPermission').onclick = requestPermission
        document.getElementById('subscribe').onclick = subscribePush
        document.getElementById('unsubscribe').onclick = unsubscribePush
        document.getElementById('testPush').onclick = sendTestPush

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', initializePushNotifications)
    </script>
</body>
</html>