<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>订阅调试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            line-height: 1.6;
        }
        .button {
            background: #1677ff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 8px 4px;
            font-size: 14px;
        }
        .log {
            background: #f5f5f5;
            border: 1px solid #d9d9d9;
            padding: 16px;
            border-radius: 6px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 500px;
            overflow-y: auto;
        }
        .success { color: #52c41a; }
        .error { color: #ff4d4f; }
        .info { color: #1677ff; }
    </style>
</head>
<body>
    <h1>🔍 推送订阅调试器</h1>
    
    <button id="getInfo" class="button">获取当前状态</button>
    <button id="testSubscribe" class="button">测试订阅</button>
    
    <h3>📝 调试日志</h3>
    <div id="log" class="log">点击按钮开始调试...\n</div>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log')
            const timestamp = new Date().toLocaleTimeString()
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info'
            logDiv.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`
            logDiv.scrollTop = logDiv.scrollHeight
        }

        async function getInfo() {
            log('获取当前订阅状态...', 'info')
            try {
                const response = await fetch('/api/debug-subscription', {
                    credentials: 'include'
                })
                const result = await response.json()
                
                if (response.ok) {
                    log(`用户: ${result.user?.name} (ID: ${result.user?.id})`, 'success')
                    log(`当前订阅数: ${result.subscriptionCount}`, 'info')
                    
                    if (result.subscriptions && result.subscriptions.length > 0) {
                        result.subscriptions.forEach((sub, i) => {
                            log(`订阅${i+1}: ${sub.endpoint.slice(-30)}...`, 'info')
                            log(`  创建时间: ${sub.created_at}`, 'info')
                            log(`  最后使用: ${sub.last_used}`, 'info')
                        })
                    }
                } else {
                    log(`获取信息失败: ${result.error}`, 'error')
                }
            } catch (error) {
                log(`请求失败: ${error.message}`, 'error')
            }
        }

        async function testSubscribe() {
            log('开始订阅测试...', 'info')
            
            try {
                // 获取推送权限
                if (Notification.permission !== 'granted') {
                    const permission = await Notification.requestPermission()
                    if (permission !== 'granted') {
                        log('推送权限被拒绝', 'error')
                        return
                    }
                }

                // 注册Service Worker
                const registration = await navigator.serviceWorker.register('/sw.js')
                log('Service Worker注册成功', 'success')

                // 获取推送订阅
                const subscription = await registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: 'BHn7QgZMASGfPzs_t1h604Z5ku_HlpZufjZZgDO1qiPopryzLII_GaInmuHqiNMhypVkz99dy2ES8tknl8n-ncE'
                })

                log('浏览器订阅成功', 'success')
                log(`端点: ${subscription.endpoint.slice(-50)}...`, 'info')

                // 调用调试API
                const response = await fetch('/api/debug-subscription', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        subscription: subscription,
                        deviceInfo: {
                            userAgent: navigator.userAgent
                        }
                    })
                })

                const result = await response.json()
                
                log(`API响应 (${response.status}):`, response.ok ? 'success' : 'error')
                log(`步骤: ${result.step}`, 'info')
                
                if (result.success) {
                    log(`✅ ${result.message}`, 'success')
                    if (result.data) {
                        log(`插入ID: ${result.data.insertedId}`, 'info')
                    }
                } else {
                    log(`❌ ${result.error}`, 'error')
                    if (result.details) {
                        log(`详细信息: ${JSON.stringify(result.details, null, 2)}`, 'info')
                    }
                }

            } catch (error) {
                log(`测试失败: ${error.message}`, 'error')
                console.error('详细错误:', error)
            }
        }

        document.getElementById('getInfo').onclick = getInfo
        document.getElementById('testSubscribe').onclick = testSubscribe
    </script>
</body>
</html>