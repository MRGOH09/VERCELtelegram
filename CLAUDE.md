# Claude Code 项目开发规则

## 🎯 核心原则
- **重用优于重写** - 优先检查和重用现有API端点、函数和逻辑
- **简单优于复杂** - 选择最简单可行的解决方案
- **一致性优于创新** - 保持与现有代码风格和格式一致

## 🐧 KISS + Linux 设计哲学
基于实战经验，建立新页面和功能必须遵循以下原则：

### **KISS原则 (Keep It Simple, Stupid)**
- **单一职责** - 每个页面/组件/API只做一件事
- **最小复杂度** - 优先选择最简单的实现方式
- **直接明了** - 避免过度抽象和复杂的中间层
- **可读性优先** - 代码要像文档一样清晰

### **Unix/Linux哲学应用**
- **小而美** - 功能模块保持精简，易于测试和维护
- **管道思维** - 数据流向清晰：输入 → 处理 → 输出
- **状态隔离** - 避免全局状态，减少副作用
- **快速失败** - 错误要立即暴露，不要静默处理
- **标准接口** - API设计遵循RESTful原则，返回格式统一

### **新页面创建检查清单**
在创建任何新页面前：
- [ ] **需求验证** - 确认这个页面是否真的需要（避免功能冗余）
- [ ] **最简实现** - 选择能解决问题的最简单方案
- [ ] **状态最小化** - 只保留必需的状态变量
- [ ] **错误边界** - 添加错误处理和边界条件检查
- [ ] **单一数据流** - 避免复杂的状态管理，优先使用props/context
- [ ] **可测试性** - 逻辑要能够独立测试
- [ ] **性能考虑** - 避免不必要的re-render和API调用

### **API设计准则**
- **一个端点一个职责** - `/api/create-user` 而不是 `/api/user-management`  
- **快速响应** - 避免长时间运行的操作阻塞请求
- **幂等性** - 相同请求多次调用结果一致
- **明确的错误码** - 使用标准HTTP状态码
- **最小数据传输** - 只返回客户端需要的数据
- **输入验证** - 服务端必须验证所有输入参数

## 🔍 编辑前检查清单
在进行任何代码修改前：
- [ ] 检查是否有现有功能可以重用
- [ ] 确认修改不会超出平台限制
- [ ] 查看相关文件的现有模式和风格

## ✅ 编辑后验证清单
每次代码修改后自动检查：
- [ ] **语法检查** - 所有变量是否已定义
- [ ] **依赖检查** - 引用的文件和函数是否存在
- [ ] **逻辑验证** - 函数调用参数是否正确
- [ ] **格式统一** - 代码风格与项目保持一致
- [ ] **错误处理** - 添加适当的错误处理和日志

## 🚫 平台限制 (Vercel Pro)
- **API函数限制**: 无限制 (之前Hobby限制: 12个)
- **Cron任务限制**: 无限制 (之前Hobby限制: 2个)
- **部署并发**: 支持多项目并发部署
- **构建时间**: 45分钟 (Hobby限制: 45分钟)
- **带宽**: 1TB/月 (Hobby限制: 100GB/月)
- **优化建议**: 虽无函数限制，仍建议模块化管理便于维护

## 📁 项目结构规则
- **API路由**: `/api/` - 主要功能端点
- **子模块**: `/api/user/`, `/api/cron/`, `/api/records/` - 分类功能
- **PWA系统**: `/pwa/` (端口3001) - Telegram登录PWA应用
- **PWA-Google系统**: `/pwa-google/` (端口3002) - Google OAuth独立PWA应用
- **配置文件**: `vercel.json`, `package.json` - 谨慎修改
- **Google Apps Script**: `/gas-scripts/` - Google Sheets同步系统
- **文档**: 保持README和相关文档更新

## 🔧 特定技术规则

### Telegram Bot
- 重用现有消息模板 (`lib/i18n.js`)
- 统一错误处理和日志格式
- 保持与现有回调处理逻辑一致

### 数据库 (Supabase)
- 使用现有数据模型和字段名
- 重用现有查询模式
- 保持事务处理一致性

### 前端集成 (PWA系统)
- 保持与现有按钮和界面风格一致
- 重用现有回调数据格式
- **PWA品牌标识**: 确保LEARNER CLUB标语和理念融入界面
- **数据一致性**: PWA与Telegram机器人数据显示必须完全一致
- **分类映射**: 使用统一的category_code映射 (food→餐饮, shop→购物等)
- **去重逻辑**: 实现与Telegram `/my`命令一致的分类去重算法

### PWA-Google独立系统 ✅ 部署完成
- **架构隔离**: 完全独立的Next.js应用，避免与主系统冲突
- **端口分离**: 使用端口3002，与主PWA系统(3001)区分
- **认证方式**: ✅ Supabase原生Google OAuth，简化维护
- **数据复用**: 重用相同的Supabase数据库和表结构
- **用户映射**: 通过用户名匹配现有用户，或创建新用户记录
- **部署状态**: ✅ Vercel生产环境部署完成 (`pwagoogle-git-main-mrgoh09s-projects.vercel.app`)
- **OAuth配置**: ✅ Google Console + Supabase配置完成，OAuth流程正常
- **环境变量**: ✅ Vercel环境变量配置完成
- **品牌一致**: 保持LEARNER CLUB品牌标识和界面风格

#### 🎯 PWA-Google下阶段优化任务

##### 界面与用户体验优化
- [ ] **首页设计**: 优化登录后的主界面，参考主PWA设计风格
- [ ] **导航菜单**: 添加侧边栏或顶部导航，包含所有功能模块
- [ ] **响应式设计**: 确保移动端和桌面端体验一致
- [ ] **加载动画**: 添加页面切换和数据加载动画效果
- [ ] **错误处理界面**: 优化错误页面显示，提供友好的用户提示

##### 功能模块开发
- [ ] **个人资料管理**: 用户信息编辑、头像上传、偏好设置
- [ ] **财务记录功能**: 记录收支、分类管理、快速录入
- [ ] **数据可视化**: 图表展示、统计分析、趋势预测
- [ ] **排行榜系统**: 个人排名、分院排行、积分竞赛
- [ ] **目标管理**: 预算设定、进度跟踪、提醒通知

##### 数据同步与集成
- [ ] **Telegram数据同步**: 与主系统数据保持一致性
- [ ] **实时数据更新**: WebSocket或定时更新机制
- [ ] **离线功能**: PWA离线缓存和同步机制
- [ ] **数据导出**: 支持Excel、PDF等格式导出
- [ ] **分享功能**: 成就分享、数据分享到社交平台

##### 性能与安全优化
- [ ] **缓存策略**: 实现有效的客户端和服务端缓存
- [ ] **代码分割**: 按页面和功能模块进行代码分割
- [ ] **SEO优化**: 添加meta标签、结构化数据
- [ ] **安全增强**: CSRF防护、XSS防护、数据加密
- [ ] **监控日志**: 错误监控、用户行为分析、性能监控

##### PWA功能增强
- [ ] **安装提示**: 添加PWA安装引导和提示
- [ ] **推送通知**: 重要提醒和更新通知
- [ ] **后台同步**: 后台数据同步和更新
- [ ] **快捷操作**: 添加常用操作的快捷方式
- [ ] **桌面集成**: 改进桌面端PWA体验

### Google Sheets同步系统
- 使用clasp自动部署到Google Apps Script
- 优先使用增强版全量同步 (`enhanced-main.gs`)
- 敏感数据必须脱敏处理
- 同步频率按数据重要性分级

## 🎯 工作流程
1. **分析需求** - 理解要解决的问题
2. **检查现有** - 查找可重用的解决方案
3. **选择方案** - 优先选择最简单的实现
4. **实现代码** - 遵循现有模式和风格
5. **自动验证** - 运行完整检查清单
6. **测试确认** - 验证功能正常工作

## 📝 提交规则
- 使用清晰的提交信息描述更改
- 包含修复的问题和添加的功能
- 添加 Claude Code 生成标记

## ✅ Git推送前检查清单
**每次代码修改完成后，必须执行以下检查再推送**：
- [ ] **Git状态检查**: 运行 `git status` 确认所有更改
- [ ] **代码格式检查**: 运行 `npm run lint` (如果存在)
- [ ] **类型检查**: 运行 `npm run typecheck` (如果存在)
- [ ] **构建测试**: 运行 `npm run build` 确保构建成功
- [ ] **提交信息**: 使用规范的提交信息格式
- [ ] **推送验证**: 确认推送到正确的分支
- [ ] **Vercel部署**: 推送后检查Vercel部署状态

## 🚀 部署规则

### Vercel部署配置
- **主项目**: 根目录自动部署到主域名
- **PWA系统**: `/pwa/` 目录部署到子路径或独立域名
- **PWA-Google**: `/pwa-google/` 目录独立部署
- **环境变量**: 各系统使用独立的环境变量配置
- **构建命令**: 
  - 主项目: 默认Node.js配置
  - PWA系统: `cd pwa && npm run build`
  - PWA-Google: `cd pwa-google && npm run build`

### Google Apps Script部署
- **使用clasp工具**: 统一使用 `./deploy.sh` 和 `./quick-update.sh` 进行部署
- **增强版优先**: 新功能优先使用增强版全量同步 (`enhanced-main.gs`)
- **敏感数据脱敏**: 所有敏感字段必须经过脱敏处理再同步
- **分级同步策略**: 按数据重要性设置同步频率（1小时/4小时/12小时/24小时）

## ⚠️ 特别注意
- **分类代码**: 统一使用中文，避免英文代码
- **API调用**: 重用现有端点，避免创建重复功能
- **错误处理**: 提供详细的错误信息和调试日志
- **格式一致性**: 保持消息格式与现有功能一致
- **系统隔离**: PWA-Google系统完全独立，避免与主系统产生冲突
- **端口管理**: 主系统(API)、PWA(3001)、PWA-Google(3002)端口分离
- **认证独立**: PWA-Google使用自己的Google OAuth和JWT管理

## 📚 扩展文档
- 🐛 **调试问题**: 参考 [调试指南](./docs/DEBUGGING_GUIDE.md)
- ❓ **常见问题**: 查看 [问题手册](./docs/COMMON_ISSUES.md)  
- 🏗️ **架构决策**: 阅读 [设计记录](./docs/ARCHITECTURE_NOTES.md)

## 🆘 快速解决问题
遇到问题时，按以下顺序查找：
1. 检查本文档的相关规则
2. 查看 [常见问题手册](./docs/COMMON_ISSUES.md) 寻找解决方案
3. 参考 [调试指南](./docs/DEBUGGING_GUIDE.md) 进行深度排查
4. 了解 [架构设计原理](./docs/ARCHITECTURE_NOTES.md) 理解背景

---
*此文件定义了项目的核心开发规范，确保代码质量和一致性*
*v2.7更新：完成PWA-Google系统Vercel部署，添加后续优化任务清单*
*v2.6更新：升级Vercel Pro平台限制，新增Git推送检查清单和部署配置*
*v2.5更新：新增PWA-Google独立系统开发规范和架构隔离规则*
*v2.4更新：重构文档结构，拆分调试和架构内容到专门文档*

## 📋 相关文档
- **调试指南**: `./docs/DEBUGGING_GUIDE.md` - 调试方法和经验总结
- **常见问题**: `./docs/COMMON_ISSUES.md` - 问题模式和解决方案
- **架构记录**: `./docs/ARCHITECTURE_NOTES.md` - 重要设计决策记录
- **PWA增强记录**: `./PWA_ENHANCEMENT_LOG.md` - 详细的PWA改进文档
- **Git提交历史**: 记录了完整的功能开发和品牌升级过程