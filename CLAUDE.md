# Claude Code 项目开发规则

## 🎯 核心原则
- **重用优于重写** - 优先检查和重用现有API端点、函数和逻辑
- **简单优于复杂** - 选择最简单可行的解决方案
- **一致性优于创新** - 保持与现有代码风格和格式一致

## 🔍 编辑前检查清单
在进行任何代码修改前：
- [ ] 检查是否有现有功能可以重用
- [ ] 确认修改不会超出平台限制
- [ ] 查看相关文件的现有模式和风格

## ✅ 编辑后验证清单
每次代码修改后自动检查：
- [ ] **语法检查** - 所有变量是否已定义
- [ ] **依赖检查** - 引用的文件和函数是否存在
- [ ] **逻辑验证** - 函数调用参数是否正确
- [ ] **格式统一** - 代码风格与项目保持一致
- [ ] **错误处理** - 添加适当的错误处理和日志

## 🚫 平台限制 (Vercel Hobby)
- **API函数限制**: 最多12个 (当前: 9个)
- **Cron任务限制**: 最多2个 (当前: 2个)
- **优先策略**: 合并功能到现有端点，避免创建新文件

## 📁 项目结构规则
- **API路由**: `/api/` - 主要功能端点
- **子模块**: `/api/user/`, `/api/cron/`, `/api/records/` - 分类功能
- **配置文件**: `vercel.json`, `package.json` - 谨慎修改
- **Google Apps Script**: `/gas-scripts/` - Google Sheets同步系统
- **文档**: 保持README和相关文档更新

## 🔧 特定技术规则

### Telegram Bot
- 重用现有消息模板 (`lib/i18n.js`)
- 统一错误处理和日志格式
- 保持与现有回调处理逻辑一致

### 数据库 (Supabase)
- 使用现有数据模型和字段名
- 重用现有查询模式
- 保持事务处理一致性

### 前端集成
- 保持与现有按钮和界面风格一致
- 重用现有回调数据格式

### Google Sheets同步系统
- 使用clasp自动部署到Google Apps Script
- 优先使用增强版全量同步 (`enhanced-main.gs`)
- 敏感数据必须脱敏处理
- 同步频率按数据重要性分级

## 🎯 工作流程
1. **分析需求** - 理解要解决的问题
2. **检查现有** - 查找可重用的解决方案
3. **选择方案** - 优先选择最简单的实现
4. **实现代码** - 遵循现有模式和风格
5. **自动验证** - 运行完整检查清单
6. **测试确认** - 验证功能正常工作

## 📝 提交规则
- 使用清晰的提交信息描述更改
- 包含修复的问题和添加的功能
- 添加 Claude Code 生成标记

## 🚀 Google Apps Script部署规则
- **使用clasp工具**: 统一使用 `./deploy.sh` 和 `./quick-update.sh` 进行部署
- **增强版优先**: 新功能优先使用增强版全量同步 (`enhanced-main.gs`)
- **敏感数据脱敏**: 所有敏感字段必须经过脱敏处理再同步
- **分级同步策略**: 按数据重要性设置同步频率（1小时/4小时/12小时/24小时）

## ⚠️ 特别注意
- **分类代码**: 统一使用中文，避免英文代码
- **API调用**: 重用现有端点，避免创建重复功能
- **错误处理**: 提供详细的错误信息和调试日志
- **格式一致性**: 保持消息格式与现有功能一致

## 🐛 重要调试经验 (v2.2更新)

### WhatsApp提醒队列系统设计经验 (2025-08-25)

**场景**: 需要每日自动识别未记录用户并生成WhatsApp提醒队列

**设计决策**:
- **重用原则**: 利用现有daily-settlement cron，避免新增cron任务
- **零维护策略**: 每天覆盖旧数据，不积累历史记录
- **KISS原则**: 简单的数据型消息模板，避免复杂逻辑
- **架构一致性**: 集成到现有GAS同步系统，保持数据流一致

**技术实现**:
- 数据表: `daily_reminder_queue` - 包含phone_e164和完整消息文本
- 查询策略: 基于昨天records表的NOT EXISTS查询
- 消息生成: 数据驱动的个性化模板（天数统计）
- 同步策略: daily级别同步（24小时），full_replace策略

**关键经验**:
- 新功能优先考虑在现有cron中扩展，而非独立cron
- Google Sheets作为中间层便于调试和监控WhatsApp发送状态
- 电话号码脱敏处理确保隐私安全（high sensitive level）

## 🐛 重要调试经验 (v2.1更新)

### 数据库Schema一致性检查
- **问题**: 字段位置错误查询（如`user_profile.branch_code`实际在`users`表）
- **解决**: 使用Linux思维系统性检查所有相关查询
- **预防**: 每次修改前确认字段所在表的准确性

### JOIN查询最佳实践
- **推荐**: 使用`user_profile.users(branch_code)`进行关联查询
- **避免**: 复杂的嵌套JOIN，优先使用分步查询
- **调试**: 添加详细日志追踪JOIN结果的数据结构

### 数据类型匹配问题
- **注意**: `chat_id`可能是number/bigint/string类型
- **解决**: 在Map查找时添加类型检查和转换
- **日志**: 记录数据类型信息便于调试匹配问题

### UPSERT vs UPDATE选择
- **UPSERT**: 仅用于确实需要"不存在则创建"的场景
- **UPDATE**: 用于更新已知存在的记录，避免意外覆盖
- **分行设置**: 使用UPDATE避免重置现有配置

## 🔍 Linux思维调试方法

### 系统性问题定位
1. **grep搜索**: 查找所有相关代码位置
2. **数据流追踪**: 从数据源到最终显示的完整链路
3. **分层验证**: 数据库→业务逻辑→用户界面逐层检查
4. **KISS原则**: 优先选择最简单可行的解决方案

### 调试日志策略
```javascript
// 数据查询日志
console.log(`[Function] 查询参数:`, queryParams)
console.log(`[Function] 查询结果:`, queryResult)

// 数据类型检查日志  
console.log(`[Function] 数据类型: ${typeof data}, 值: ${data}`)

// 映射过程日志
console.log(`[Function] 映射前:`, sourceMap.entries())
console.log(`[Function] 映射后:`, targetMap.entries())
```

### 问题分类和优先级
1. **Critical**: 核心功能完全失效（如分行无法设置）
2. **High**: 功能异常但有备选方案（如排行榜显示问题）
3. **Medium**: 用户体验问题（如提示文本不准确）
4. **Low**: 非关键优化项

## 📋 代码审查检查清单 (新增)

### 数据库操作检查
- [ ] 确认字段在正确的表中
- [ ] JOIN查询语法正确
- [ ] 数据类型匹配无误
- [ ] UPSERT/UPDATE选择合适

### 功能逻辑检查
- [ ] 数据流从源到终的完整性
- [ ] 错误处理覆盖边界情况
- [ ] 日志信息足够详细便于调试
- [ ] 用户体验流程合理

### 性能和维护性
- [ ] 查询语句高效无冗余
- [ ] 代码复用现有函数
- [ ] 变量命名清晰易懂
- [ ] 注释说明复杂逻辑

---
*此文件定义了项目的开发规范，确保代码质量和一致性*
*v2.2更新：新增WhatsApp提醒队列系统设计经验*
*v2.1更新：新增Linux思维调试方法和重要调试经验*